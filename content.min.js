var $timer,$dltimer=false,$lastSrch="",$msgTimer,$siteList,$curWIndex=0,$currentVersion=false,$currentXhr=false;loadScript();function loadScript(){clearInterval($timer);if(typeof jQuery!=="undefined"){var b=$("#content .search .sinput input").val(),d=$("#jsSearchFilter"),c=d.length?d.serializeObject():{};if(b==undefined){b=""}if($currentXhr){$currentXhr.abort();$currentXhr=false}showLoader($(".content-wrapper"));var a={task:"getTasks",userid:localStorage.userid,search:b};$.extend(a,c);$currentXhr=$.ajax({url:"https://tireos.info/staff.info.php",data:a,type:"POST",dataType:"JSON",success:function(i,n,m){let $dataJson=i;$("#jsStaff tbody").html("");if(i.length){var h="",g=false;$.each(i,function(q,u){var t=(u.RUN===true)?" active":"",r=(u.BALANCE_EMPTY==true)?" emptybalance":"",o=(u.TITLE!=false&&u.TITLE!=undefined)?'<a href="https://tireos.info/company/personal/user/'+u.USER_ID+"/tasks/task/view/"+u.TASK_ID+'/" target="_blank">'+u.TITLE+"</a>":"",s,v;if(t){g=true}if(t){var p=u.TASK_ID;$timer=setInterval(function(){let $resultTime;u.CURRENT_LENGTH++;v=parseInt(u.RUN_TIME)+parseInt(u.CURRENT_LENGTH);$("#taskTimer"+p).html(timeFormat(Number(v)*1000));$resultTime=parseFloat(i[0].TOTAL.TIME)+parseFloat(u.CURRENT_LENGTH/3600);$("#jsTotalTimer").html($.number($resultTime,2,".",""))},1000)}v=parseInt(u.RUN_TIME)+parseInt(u.CURRENT_LENGTH);s=timeFormat(Number(t?v:u.RUN_TIME)*1000);h+='<tr class="'+t+r+'"'+(u.BALANCE_EMPTY?' title="Баланс требует пополнения, нельзя продолжить"':"")+">"+((u.NO_RUN||u.BALANCE_EMPTY)?"<td></td>":'<td class="play"><i class="fa '+(t?"fa-pause":"fa-play")+' playbtn" data-task="'+u.TASK_ID+'" data-user="'+u.USER_ID+'" data-action="'+(t?"stop":"start")+'"></i></td>')+'<td class="name">'+u.SITE+(u.GROUP_BALANCE==false?"":"&nbsp;["+u.GROUP_BALANCE+"&nbsp;руб]")+'</td><td class="task">'+o+" ["+u.TASK_ID+']</td><td class="time" id="taskTimer'+u.TASK_ID+'">'+(s?s:"00:00:00")+"</td></tr>"});$ico=g?"ico2.png":"ico.png";chrome.browserAction.setIcon({path:{"48":$ico,"64":$ico,"128":$ico}});var f=i[0].TOTAL.TIMEFULL?"":", осталось: "+i[0].TOTAL.REMAIN+"ч";h+='<tr><td colspan="4" class="result'+(i[0].TOTAL.TIMEFULL?" full":"")+'">Наработано: <span id="jsTotalTimer">'+i[0].TOTAL.TIME_ALL+"</span>ч"+f+"</td></tr>"}else{h+='<tr><td class="empty">Ничего не найдено</td></tr>'}$("#jsStaff").html(h);addPlayOptions();hideLoader($("body"));$("body").addClass("showed");if(!$currentVersion){var l=window.location,e=l.href.substring(0,l.href.lastIndexOf("/")+1);$.ajax({url:e+"version.txt",error:function(){},success:function(o){if(o){$currentVersion=o;getRemoteVersion()}}})}hideLoader($(".content-wrapper"))},error:function(e,g,f){if(e.statusText=="abort"){return}$("#jsStaff tbody").html("Не удалось загрузить данные")}})}}function showLoader(b){if(typeof(b)!=="object"||!b.length){return}var a=b.find(">.loader");if(a.length){return}b.append($('<div class="loader"></div>'))}function hideLoader(b){if(typeof(b)!=="object"||!b.length){return}var a=b.find(">.loader");if(!a.length){return}a.remove()}function getRemoteVersion(){$.ajax({url:"https://tireos.net/_util/get.php",data:{a:"getlibver",id:267},type:"POST",error:function(){},success:function(a){if(a&&$currentVersion&&($currentVersion!=a)){$("#jsSearchBlock").after($('<div class="s-plug-warning">Ваш плагин устарел. Пожалуйста, загрузите<br />последнюю версию с сайта <a href="https://tireos.net/tslibrary/phplib/" target="_blank">tireos.net</a></div>'))}}})}function addPlayOptions(){$("table#jsStaff .playbtn").on("click",function(){var b=$(this).data("task");var a=$(this).data("user");var c=$(this).data("action");$(this).addClass("wait");$.ajax({url:"https://tireos.info/task.control.php?task="+b+"&user="+a+"&action="+c}).done(function(d){loadScript()})})}function loadSearch(){$("#content .search .sinput input").on("keyup",function(a){var b=$("#content .search .sinput input").val();if($lastSrch!=b){if($dltimer){clearTimeout($dltimer)}$dltimer=setTimeout(function(){loadScript();$lastSrch=b;$dltimer=false},500)}})}function loadAddTaskMenu(){$("select").fSelect({showSearch:false,placeholder:"Поиск по статусу"});$("#content .search .addbtn").on("click",function(){$(this).next().toggleClass("opened").find(".namefld").focus()});$("#content .search .addform").on("submit",function(){var b=$(this),a=b.serializeObject(),c=checkFormVals(b);if(!c){return false}a.time=b.find("input.timefld").data("time");$.ajax({url:"https://tireos.info/bitrix/templates/bitrix24/components/bitrix/news.list/taskview/add.php",data:a,method:"POST",dataType:"json"}).done(function(d){if(d.ID){b.removeClass("opened");b[0].reset();makeMsg("Время по задаче добавлено")}else{alert("Не удалось создать задачу")}});return false});$("#jsSearchFilter select").on("change",function(){loadScript()});$.ajax({url:"https://tireos.info/tctrl/site.list.php",dataType:"json"}).done(function(a){$siteList=a;loadFinder($("#sitefld"),$("#sitelist"),$siteList)});$(document).click(function(a){if(!$(a.target).closest("#content .search .addform").length&&!$(a.target).closest("#content .search .addbtn").length&&!$("#ui-datepicker-div").is(":visible")){$("#content .search .addform").removeClass("opened")}});$.datepicker.regional.ru={closeText:"Закрыть",prevText:"&#x3c;Пред",nextText:"След&#x3e;",currentText:"Сегодня",monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthNamesShort:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],dayNames:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],dayNamesShort:["вск","пнд","втр","срд","чтв","птн","сбт"],dayNamesMin:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],weekHeader:"Нед",dateFormat:"dd.mm.yy",firstDay:1,isRTL:false,showMonthAfterYear:false,yearSuffix:""};$.datepicker.setDefaults($.datepicker.regional.ru);$("#content .search .addform .datefld").datepicker({dateFormat:"dd.mm.yy"});$("#content .search .addform .timefld").inputmask("99.99",{clearIncomplete:true}).on("change",function(){var e=0;if($(this).val()){e=parseFloat($(this).val())}var g=Math.floor(e);var b=parseFloat(e-g);var h=b*100/60;var c=g+h;$(this).data("time",c);var a=Math.floor(c);var f=(c-a)*60/100;var d=a+"."+f});$(document).on("keydown",function(c){if(c.which==27){var a=0,b=false;$("*[data-windex]").each(function(){var d=$(this).data("windex");if($(this).is(":visible")&&a<d){b=$(this);a=d}});if(b){b.trigger("onescape");return false}}});$("#content .addform").on("onescape",function(){$(this).removeClass("opened")});$("#content .sitefld").on("valchange",function(){$("#content .timefld").focus()});makeTabs();loadNewMessages()}function loadNewMessages(a){if(typeof(a)==="undefined"||!a){a=1}$.ajax({url:"https://tireos.info/_util/plug.php",method:"POST",dataType:"json",data:{PAGE:a,a:"unreadmsg"}}).done(function(b){if(!b.ITEMS||!b.ITEMS.length){return}$("#jsUnreadTasks tbody").html("");for(k in b.ITEMS){var d=$("<tr><td>"+b.ITEMS[k].ID+'</td><td><a target="_blank" href="https://tireos.info/company/personal/user/'+b.USER_ID+"/tasks/task/view/"+b.ITEMS[k].ID+'/">'+b.ITEMS[k].TITLE+"</a> ("+b.ITEMS[k].CNT+")</td><td>"+b.ITEMS[k].POST_DATE_SHORT+"</td></tr>");$("#jsUnreadTasks tbody").append(d)}if(b.PAGES>1){var e=$('<tr><td colspan="3"><div class="s-plug-paging"></div></td></tr>');$("#jsUnreadTasks tbody").append(e);for(j=1;j<=b.PAGES;j++){if(j==a){var c=$("<span>"+j+"</span>")}else{var c=$('<a href="#" data-page="'+j+'">'+j+"</a>");c.on("click",function(){loadNewMessages($(this).data("page"))})}$("#jsUnreadTasks .s-plug-paging").append(c)}}if(b.ITEMS.length>0){$(".s-plug-nm-count").html("("+b.ITEMS.length+")")}})}function makeTabs(){$(".s-plug-tabs > div").on("click",function(){var c=$(this).index(),b=$(this).closest(".s-plug-tabs"),a=$(b.data("for"));if(a.length){a.find(">div").eq(c).show().siblings().hide();$(this).addClass("active").siblings().removeClass("active")}})}function loadFinder(d,b,c){var a=false;d.on("keyup",function(h){if(h.which==27){return}if(a){a=false;return}var f=$(this);var g=[];var i=$(this).val();for(k in c){if(c[k].toLowerCase().indexOf(i)>=0){g.push(c[k])}}b.html("");for(k in g){b.append('<div tabindex="1">'+g[k]+"</div>")}if(g.length){b.show()}else{b.hide()}b.find(">div").on("keydown",function(m){var e=parseInt($(this).index());var n=e+1;var l=e-1;if(m.which==40&&e<$(this).siblings().length){b.find(">div:eq("+n+")").focus()}else{if(m.which==38&&e>0){b.find(">div:eq("+l+")").focus()}else{if(m.which==13){$(this).trigger("click");f.trigger("valchange");a=true;m.stopPropagation();m.preventDefault()}else{if(m.which==27){f.trigger("clrfield").focus();return false}}}}}).on("click",function(){var e=$(this).html();f.val(e).data("val",e);b.html("").hide();return false})}).on("keydown",function(f){if(f.which==40){b.find(">div:eq(0)").focus()}else{if(f.which==27){$(this).trigger("clrfield");return false}}}).on("clrfield",function(){b.html("").hide();$(this).val($(this).data("val"))});$(document).click(function(f){var e=$(f.target);if(!$.contains(e,b)&&!(e.is(b))&&!$.contains(e,d)&&!(e.is(d))){d.trigger("clrfield")}})}function makeMsg(a){$("#addTimeSuccess").html(a).addClass("showed");if($msgTimer){clearTimeout($msgTimer)}$msgTimer=setTimeout(function(){$("#addTimeSuccess").removeClass("showed")},3000)}function checkFormVals(a){$ok=true;a.find("input.req").each(function(){if(!$(this).val()){$(this).addClass("err");$ok=false}else{$(this).removeClass("err")}});a.find("select.req").each(function(){if(!$(this).val()){$(this).addClass("err");$ok=false}else{$(this).removeClass("err")}});return $ok}if(typeof jQuery!=="undefined"){$(function(){loadSearch();loadAddTaskMenu()})}var timeFormat=(function(){function a(b){b=Math.floor(b);return b<10?"0"+b:b}return function(c){var e=c/1000,b=e/3600,d=e/60%60,f=e%60;return a(b)+":"+a(d)+":"+a(f)}})();if(typeof jQuery!=="undefined"){$.fn.serializeObject=function(){var c={};var b=this.serializeArray();$.each(b,function(){if(c[this.name]!==undefined){if(!c[this.name].push){c[this.name]=[c[this.name]]}c[this.name].push(this.value||"")}else{c[this.name]=this.value||""}});return c}};